const express = require('express')
const axios = require('axios')

const app = express()
app.use(express.json())

// ÙˆØ§Ø¬Ù‡Ø© HTML Ø¬Ø§Ù‡Ø²Ù‡ Ù…Ø±Ø³ÙˆÙ…Ù‡ Ù…Ù† Ù‡Ù†Ø§
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="ar">
    <head>
      <meta charset="UTF-8">
      <title>ØªØ­Ù…ÙŠÙ„ ØªÙŠÙƒ ØªÙˆÙƒ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø©</title>
    </head>
    <body style="background:#111;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
      <h1 style="font-family:sans-serif;">ğŸ¥ ØªØ­Ù…ÙŠÙ„ ØªÙŠÙƒ ØªÙˆÙƒ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø©</h1>
      <input id="videoURL" placeholder="Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙŠÙƒ ØªÙˆÙƒ" style="padding:10px;width:300px;border:none;border-radius:4px;">
      <button onclick="download()" style="padding:10px 20px;margin-top:10px;border:none;border-radius:4px;background:#fff;color:#111;font-weight:bold;">ØªØ­Ù…ÙŠÙ„</button>

      <script>
        async function download() {
          const url = document.getElementById('videoURL').value
          const res = await fetch('/api/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          })
          const data = await res.json()
          if (data.download) window.open(data.download)
          else alert('ØµØ§Ø± ÙÙŠÙ‡ Ø®Ø·Ø£')
        }
      </script>
    </body>
    </html>
  `)
})

// API Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† watermark
app.post('/api/download', async (req, res) => {
  const videoURL = req.body.url
  if (!videoURL) return res.status(400).json({ error: 'Ø­Ø· Ø±Ø§Ø¨Ø· ÙŠØ§Ù„Ø°ÙŠØ¨' })

  try {
    // API Ø®Ø§Ø±Ø¬ÙŠ Ù…Ø¬Ø§Ù†ÙŠ tikwm
    const api = `https://api.tikwm.com/?url=${encodeURIComponent(videoURL)}`
    const result = await axios.get(api)

    if (result.data.data && result.data.data.play) {
      return res.json({ download: result.data.data.play })
    } else {
      return res.status(400).json({ error: 'Ù…Ø§ Ø­ØµÙ„Øª Ø±Ø§Ø¨Ø· Ù†Ø¸ÙŠÙ' })
    }

  } catch (err) {
    console.log(err)
    res.status(500).json({ error: 'ÙÙŠÙ‡ Ù…Ø´ÙƒÙ„Ù‡ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±' })
  }
})

const port = process.env.PORT || 3000
app.listen(port, () => {
  console.log('Ø´ØºØ§Ù„ Ø¹Ø§Ù„Ù…Ù†ÙØ° ' + port)
})
